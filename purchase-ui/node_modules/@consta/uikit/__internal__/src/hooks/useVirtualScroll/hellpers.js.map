{"version":3,"file":"hellpers.js","names":["useCallback","useEffect","getElementSize","useMutableRef","defaultItemsCalculationCount","arraysIsEq","arr1","arr2","join","useScroll","ref","fn","isActive","current","addEventListener","removeEventListener","getElementHeight","el","height","roundPositionByGap","position","gap","Math","ceil","getVisiblePosition","top","elementMaxSize","visiblePosition","calculateSavedSizes","savedSizes","sizes","element","newSavedSizes","index","length","useCalculateVisiblePosition","scrollElement","set","elementsSizes","elementMaxSizeRef","max","apply","scrollTop","state","addCount","pxs","savedSize","lastSavedSize","slice","average","reduce","a","b","add","calculateBounds","indexs"],"sources":["../../../../../src/hooks/useVirtualScroll/hellpers.ts"],"sourcesContent":["import { RefObject, useCallback, useEffect } from 'react';\n\nimport { getElementSize } from '##/hooks/useComponentSize';\nimport { useMutableRef } from '##/hooks/useMutableRef';\n\nexport type UseVirtualScrollProps = {\n  length: number;\n  isActive?: boolean;\n  onScrollToBottom?: (index: number) => void;\n};\n\nexport type UseVirtualScrollReturn<ITEM_ELEMENT, SCROLL_ELEMENT> = {\n  listRefs: React.RefObject<ITEM_ELEMENT>[];\n  scrollElementRef: React.RefObject<SCROLL_ELEMENT>;\n  slice: [number, number];\n  spaceTop: number;\n};\n\nexport type Bounds = [[number, number], [number, number]];\n\nexport const defaultItemsCalculationCount = 5;\n\nexport const arraysIsEq = (arr1: number[], arr2: number[]) =>\n  arr1.join('-') === arr2.join('-');\n\nexport const useScroll = (\n  ref: RefObject<HTMLElement>,\n  fn: () => void,\n  isActive: boolean,\n) => {\n  useEffect(() => {\n    if (isActive) {\n      ref.current?.addEventListener('scroll', fn);\n    }\n\n    return () => {\n      ref.current?.removeEventListener('scroll', fn);\n    };\n  }, [ref.current, fn, isActive]);\n};\n\nexport const getElementHeight = (el: HTMLElement | SVGGraphicsElement | null) =>\n  getElementSize(el).height;\n\nconst roundPositionByGap = (position: number, gap: number) => {\n  if (position <= 0) {\n    return 0;\n  }\n  return Math.ceil(position / gap) * gap;\n};\n\nexport const getVisiblePosition = (\n  top: number,\n  height: number,\n  elementMaxSize: number,\n): [number, number] => {\n  const gap =\n    height > elementMaxSize * defaultItemsCalculationCount\n      ? height * 1.5\n      : elementMaxSize * defaultItemsCalculationCount;\n\n  const visiblePosition: [number, number] = [\n    Math.ceil(roundPositionByGap(top - gap, height)),\n    Math.ceil(roundPositionByGap(top === 0 ? gap : top + gap, height)),\n  ];\n\n  return visiblePosition;\n};\n\nexport const calculateSavedSizes = (savedSizes: number[], sizes: number[]) => {\n  const newSavedSizes = [...savedSizes];\n  for (let index = 0; index < sizes.length; index++) {\n    const element = sizes[index];\n    if (element > 0) {\n      newSavedSizes[index] = element;\n    }\n  }\n  return newSavedSizes;\n};\n\nexport const useCalculateVisiblePosition = (\n  scrollElement: HTMLElement | null,\n  set: (value: React.SetStateAction<[number, number]>) => void,\n  elementsSizes: number[],\n) => {\n  const elementMaxSizeRef = useMutableRef(Math.max.apply(null, elementsSizes));\n\n  return useCallback(() => {\n    if (!scrollElement) {\n      return;\n    }\n\n    const visiblePosition = getVisiblePosition(\n      scrollElement.scrollTop,\n      getElementHeight(scrollElement),\n      elementMaxSizeRef.current,\n    );\n\n    set((state) => {\n      if (visiblePosition[0] !== state[0] || visiblePosition[1] !== state[1]) {\n        return visiblePosition;\n      }\n\n      return state;\n    });\n  }, [scrollElement, set]);\n};\n\nconst addCount = (\n  pxs: [number, number],\n  visiblePosition: [number, number],\n  savedSize: number[],\n) => {\n  const lastSavedSize = savedSize.slice(-50);\n  const average =\n    lastSavedSize.reduce((a, b) => a + b, 0) / lastSavedSize.length;\n\n  let add = defaultItemsCalculationCount;\n\n  while (visiblePosition[1] >= pxs[1] + add * average) {\n    add += defaultItemsCalculationCount;\n  }\n\n  return add;\n};\n\nexport const calculateBounds = (\n  savedSizes: number[],\n  sizes: number[],\n  visiblePosition: [number, number],\n  length: number,\n): Bounds => {\n  const pxs: [number, number] = [0, 0];\n  const indexs: [number, number] = [0, 0];\n\n  for (let index = 0; index < savedSizes.length; index++) {\n    if (visiblePosition[0] > pxs[0]) {\n      pxs[0] += savedSizes[index];\n      indexs[0] = index + 1;\n    }\n\n    if (visiblePosition[1] > pxs[1]) {\n      pxs[1] += savedSizes[index];\n      indexs[1] = index + 1;\n    }\n  }\n\n  if (indexs[0] === 0 && indexs[1] === 0) {\n    indexs[1] = defaultItemsCalculationCount;\n  }\n\n  if (sizes.length !== savedSizes.length) {\n    indexs[1] += addCount(pxs, visiblePosition, savedSizes);\n  }\n\n  if (indexs[1] > length) {\n    indexs[1] = length;\n  }\n\n  return [pxs, indexs];\n};\n"],"mappings":"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"}